name: Go Tests

on:
  workflow_call:
    inputs:
      test_path:
        description: 'Go package path to test (e.g. ./internal/...)'
        type: string
        default: './...'
      race:
        description: 'Enable race detector'
        type: boolean
        default: true
      coverage:
        description: 'Generate and upload coverage report'
        type: boolean
        default: true
      ref:
        description: 'Git ref to checkout (branch, tag, or SHA)'
        type: string
        default: ''

jobs:
  test:
    name: Go Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run tests
        run: go test ${{ inputs.race && '-race' || '' }} -count=1 -v ${{ inputs.test_path }}

      - name: Generate coverage report
        if: inputs.coverage
        run: go test -coverprofile=coverage.out -covermode=atomic ${{ inputs.test_path }}

      - name: Print coverage summary
        if: inputs.coverage
        run: go tool cover -func=coverage.out | tail -1

      - uses: actions/upload-artifact@v4
        if: always() && inputs.coverage
        with:
          name: go-coverage
          path: coverage.out
          retention-days: 7
