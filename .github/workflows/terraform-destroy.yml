name: Terraform Destroy

on:
  workflow_call:
    inputs:
      terraform_dir:
        description: 'Directory containing Terraform files'
        type: string
        default: 'terraform'
      aws_region:
        description: 'AWS region'
        type: string
        default: 'us-east-1'
      aws_role_arn:
        description: 'IAM role ARN (use secrets.AWS_ROLE_ARN if sensitive)'
        type: string
        default: ''
      approvers:
        description: 'Comma-separated GitHub usernames for manual approval'
        type: string
        required: true
      confirm:
        description: 'Must be "destroy" to proceed'
        type: string
        required: true
      preserve_modules:
        description: 'Comma-separated Terraform modules to preserve (e.g. "module.iam"). These are removed from state before destroy and re-imported after.'
        type: string
        default: 'module.iam'
    secrets:
      TF_API_TOKEN:
        description: 'Terraform Cloud API token (optional)'
        required: false
      AWS_ROLE_ARN:
        description: 'IAM role ARN (alternative to inputs.aws_role_arn)'
        required: false

jobs:
  validate-input:
    name: Validate Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        if: inputs.confirm != 'destroy'
        run: |
          echo "::error::You must type 'destroy' to confirm. Got: '${{ inputs.confirm }}'"
          exit 1

  plan-destroy:
    name: Plan Destroy
    runs-on: ubuntu-latest
    needs: validate-input
    outputs:
      plan_summary: ${{ steps.plan-summary.outputs.summary }}
      resources_table: ${{ steps.resources.outputs.table }}
      preserved_note: ${{ steps.resources.outputs.preserved_note }}
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN || inputs.aws_role_arn }}
          aws-region: ${{ inputs.aws_region }}
          role-duration-seconds: 7200

      - name: Terraform Init
        run: terraform -chdir=${{ inputs.terraform_dir }} init

      - name: Build destroy targets
        id: targets
        run: |
          # Get all root-level modules from state
          ALL_MODULES=$(terraform -chdir=${{ inputs.terraform_dir }} state list 2>/dev/null \
            | grep -oP '^module\.\w+' | sort -u || true)

          PRESERVE="${{ inputs.preserve_modules }}"
          TARGETS=""

          for mod in $ALL_MODULES; do
            SKIP=false
            IFS=',' read -ra PRESERVED <<< "$PRESERVE"
            for p in "${PRESERVED[@]}"; do
              p=$(echo "$p" | xargs)  # trim whitespace
              if [ "$mod" = "$p" ]; then
                SKIP=true
                break
              fi
            done
            if [ "$SKIP" = "false" ]; then
              TARGETS="${TARGETS} -target=${mod}"
            fi
          done

          echo "targets=${TARGETS}" >> "$GITHUB_OUTPUT"
          echo "Destroy targets: ${TARGETS}"
          echo "Preserved: ${PRESERVE}"

      - name: Terraform Plan (targeted destroy)
        run: |
          terraform -chdir=${{ inputs.terraform_dir }} plan -destroy \
            ${{ steps.targets.outputs.targets }} \
            -no-color -input=false 2>&1 | tee /tmp/plan.txt

      - name: Extract plan summary
        id: plan-summary
        if: always()
        run: |
          SUMMARY=$(tail -40 /tmp/plan.txt | head -35)
          {
            echo "summary<<EOFPLAN"
            echo "$SUMMARY"
            echo "EOFPLAN"
          } >> "$GITHUB_OUTPUT"

      - name: Extract resources affected
        id: resources
        run: |
          python3 - << 'PYEOF'
          import re, os

          with open("/tmp/plan.txt") as f:
              plan = f.read()

          destroyed = re.findall(r'#\s+([\w_.[\]]+)\s+will be destroyed', plan)

          destroy_match = re.search(r'Plan:.*?(\d+) to destroy', plan)
          destroy_count = int(destroy_match.group(1)) if destroy_match else len(destroyed)

          preserve = "${{ inputs.preserve_modules }}"

          lines = []
          lines.append(f"> **{destroy_count}** resources will be destroyed")
          lines.append("")
          if destroyed:
              lines.append("| Resource | Action |")
              lines.append("|----------|--------|")
              for res in destroyed[:25]:
                  lines.append(f"| `{res}` | destroy |")
              if len(destroyed) > 25:
                  lines.append(f"| ... and {len(destroyed) - 25} more | destroy |")
          table = "\n".join(lines)

          preserved_note = ""
          if preserve.strip():
              preserved_note = f"**Preserved (not destroyed):** `{preserve}`"

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write("table<<EOFTABLE\n")
              f.write(table + "\n")
              f.write("EOFTABLE\n")
              f.write(f"preserved_note={preserved_note}\n")
          PYEOF

      - name: Write destroy plan to job summary
        run: |
          echo "## Terraform Destroy Plan" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Preserved modules:** ${{ inputs.preserve_modules }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat /tmp/plan.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

  approve-destroy:
    name: Approve Destruction
    runs-on: ubuntu-latest
    needs: plan-destroy
    steps:
      - uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.token }}
          approvers: ${{ inputs.approvers }}
          minimum-approvals: 1
          issue-title: "DESTROY infrastructure â€” run ${{ github.run_id }}"
          issue-body: |
            **This will destroy Terraform-managed infrastructure.**

            ${{ needs.plan-destroy.outputs.preserved_note }}

            ## Destroy Plan

            ```
            ${{ needs.plan-destroy.outputs.plan_summary }}
            ```

            ## Resources Affected

            ${{ needs.plan-destroy.outputs.resources_table }}

            ---

            Full destroy plan: [workflow run summary](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            **Approve** this issue to proceed with destruction, or **close** to cancel.
          exclude-workflow-initiator-as-approver: false

  destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    needs: [plan-destroy, approve-destroy]
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN || inputs.aws_role_arn }}
          aws-region: ${{ inputs.aws_region }}
          role-duration-seconds: 7200

      - name: Terraform Init
        run: terraform -chdir=${{ inputs.terraform_dir }} init

      - name: Build destroy targets
        id: targets
        run: |
          ALL_MODULES=$(terraform -chdir=${{ inputs.terraform_dir }} state list 2>/dev/null \
            | grep -oP '^module\.\w+' | sort -u || true)

          PRESERVE="${{ inputs.preserve_modules }}"
          TARGETS=""

          for mod in $ALL_MODULES; do
            SKIP=false
            IFS=',' read -ra PRESERVED <<< "$PRESERVE"
            for p in "${PRESERVED[@]}"; do
              p=$(echo "$p" | xargs)
              if [ "$mod" = "$p" ]; then
                SKIP=true
                break
              fi
            done
            if [ "$SKIP" = "false" ]; then
              TARGETS="${TARGETS} -target=${mod}"
            fi
          done

          echo "targets=${TARGETS}" >> "$GITHUB_OUTPUT"

      - name: Terraform Destroy (targeted)
        run: |
          terraform -chdir=${{ inputs.terraform_dir }} destroy \
            ${{ steps.targets.outputs.targets }} \
            -auto-approve -input=false

      - name: Write result to job summary
        if: always()
        run: |
          echo "## Destroy Result" >> "$GITHUB_STEP_SUMMARY"
          echo "Status: ${{ job.status }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Preserved: ${{ inputs.preserve_modules }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Run by: ${{ github.actor }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Timestamp: $(date -u)" >> "$GITHUB_STEP_SUMMARY"
