name: Terraform Destroy

on:
  workflow_call:
    inputs:
      terraform_dir:
        description: 'Directory containing Terraform files'
        type: string
        default: 'terraform'
      aws_region:
        description: 'AWS region'
        type: string
        default: 'us-east-1'
      aws_role_arn:
        description: 'IAM role ARN to assume via OIDC'
        type: string
        required: true
      approvers:
        description: 'Comma-separated GitHub usernames for manual approval'
        type: string
        required: true
      confirm:
        description: 'Must be "destroy" to proceed'
        type: string
        required: true
    secrets:
      TF_API_TOKEN:
        description: 'Terraform Cloud API token (optional)'
        required: false

jobs:
  validate-input:
    name: Validate Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        if: inputs.confirm != 'destroy'
        run: |
          echo "::error::You must type 'destroy' to confirm. Got: '${{ inputs.confirm }}'"
          exit 1

  plan-destroy:
    name: Plan Destroy
    runs-on: ubuntu-latest
    needs: validate-input
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws_role_arn }}
          aws-region: ${{ inputs.aws_region }}

      - name: Terraform Init
        run: terraform -chdir=${{ inputs.terraform_dir }} init

      - name: Terraform Plan (destroy)
        run: terraform -chdir=${{ inputs.terraform_dir }} plan -destroy -no-color -input=false 2>&1 | tee /tmp/plan.txt

      - name: Write destroy plan to job summary
        run: |
          echo "## Terraform Destroy Plan" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat /tmp/plan.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

  approve-destroy:
    name: Approve Destruction
    runs-on: ubuntu-latest
    needs: plan-destroy
    steps:
      - uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.token }}
          approvers: ${{ inputs.approvers }}
          minimum-approvals: 1
          issue-title: "DESTROY all infrastructure â€” run ${{ github.run_id }}"
          issue-body: |
            **This will destroy all Terraform-managed infrastructure.**

            Review the destroy plan in the [workflow run summary](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).

            Approve this issue to proceed, or close to cancel.
          exclude-workflow-initiator-as-approver: false

  destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    needs: approve-destroy
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws_role_arn }}
          aws-region: ${{ inputs.aws_region }}

      - name: Terraform Init
        run: terraform -chdir=${{ inputs.terraform_dir }} init

      - name: Terraform Destroy
        run: terraform -chdir=${{ inputs.terraform_dir }} destroy -auto-approve -input=false

      - name: Write result to job summary
        if: always()
        run: |
          echo "## Destroy Result" >> "$GITHUB_STEP_SUMMARY"
          echo "Status: ${{ job.status }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Run by: ${{ github.actor }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Timestamp: $(date -u)" >> "$GITHUB_STEP_SUMMARY"
